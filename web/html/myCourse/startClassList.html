<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="../../lib/bootstrap/css/bootstrap.css">
    <link rel="stylesheet" href="../../lib/bootstrap-table/bootstrap-table.css">
    <link rel="stylesheet" href="../../static/h-ui.admin/css/iconStyle.css" />
    <link rel="stylesheet" href="../../static/h-ui.admin/css/public.css" />
    <style>
        .btn{padding: 2px 4px}
    </style>
</head>
<body>
<div class="IndexRight">
    <h6 class="page_title">
        <img src="../../images/module_title.png">
        <span>开课申请</span>
    </h6>
    <div class="panel panel-default panel-success">
        <div class="panel-heading">
            <span>您本学年开课申请通过的课程</span>
            <span style="position: absolute;right: 30px">
                    <button id="addCurse" type="button" class="btn btn-primary">开课申请</button>
                </span>
        </div>
        <div class="panel-body">
            <table id="tableTop" data-toggle="table" table-no-bordered="false"  data-toggle="table"  data-method="post" data-toolbar="#toolbar" data-pagination="true"  data-page-list="[5,10,15]" data-unique-id="id" data-page-size="10">
                <thead>
                <tr>
                    <!--<th data-field="curriculum_num" data-align="center">课程号</th>-->
                    <th data-field="curriculum_name" data-align="center">课程名称</th>
                    <th data-field="college_name" data-align="center">开课院系</th>
                    <th data-formatter="thAlready" data-align="center">课程状态</th>
                    <th data-formatter="operation" data-align="center">操作</th>
                </tr>
                </thead>
            </table>
        </div>
    </div>
    <div class="panel panel-default panel-info">
        <div class="panel-heading">开课申请审核中的课程</div>
        <div class="panel-body">
            <table id="tableDom" data-toggle="table" table-no-bordered="false"  data-toggle="table"  data-method="post" data-toolbar="#toolbar" data-pagination="true"  data-page-list="[5,10,15]" data-unique-id="id" data-page-size="10">
                <thead>
                <tr>
                    <!--<th data-field="curriculum_num" data-align="center">课程号</th>-->
                    <th data-field="curriculum_name" data-align="center">课程名称</th>
                    <!--<th data-field="user_name" data-align="center">主讲教师</th>-->
                    <th data-field="college_name" data-align="center">开课院系</th>
                    <th data-formatter="thAlready" data-align="center">课程状态</th>
                    <th data-formatter="operation" data-align="center">操作</th>
                </tr>
                </thead>
            </table>
        </div>
    </div>

    <div class="panel panel-default panel-danger"><!-- 驳回的课程 -->
        <div class="panel-heading">开课申请驳回的课程</div>
        <div class="panel-body">
            <table id="reject_lesson" data-toggle="table" table-no-bordered="false"  data-toggle="table"  data-method="post" data-toolbar="#toolbar" data-pagination="true"  data-page-list="[5,10,15]" data-unique-id="id" data-page-size="10">
                <thead>
                <tr>
                    <!--<th data-field="curriculum_num" data-align="center">课程号</th>-->
                    <th data-field="curriculum_name" data-align="center">课程名称</th>
                    <th data-field="college_name" data-align="center">开课院系</th>
                    <th data-formatter="thAlready" data-align="center">课程状态</th>
                    <th data-field="reason" data-align="center">驳回原因</th>
                    <th data-formatter="operation_1" data-align="center">操作</th>
                </tr>
                </thead>
            </table>
        </div>
    </div><!-- 驳回的课程 结束-->
    <link rel="stylesheet" href="../../static/h-ui.admin/css/public.css" /><!-- 再次提交驳回课程 -->
    <div class="panel panel-default panel-success" id='apply_again' style='display: none;'>
        <div class="panel-heading">再次提交被驳回的开课申请</div>
        <div class="panel-body">
            <div class="IndexRight">
                <div class="prompt">
                    <div class="text">带*的为必填</div>
                </div>
                <table class="table table-bordered tables">
                    <tbody>
                    <tr>
                        <td class="tableLeft"><span style="color: red;margin-right: 4px">*</span>课程名称</td>
                        <td><input id="curriculumName" type="text" placeholder="" class="input-text"></td>
                    </tr>
                    <tr>
                        <td class="tableLeft"><span style="color: red;margin-right: 4px;visibility: hidden">*</span>开课院系</td>
                        <td>
                            <select id="department"></select>
                        </td>
                    </tr>
                    <tr>
                        <td class="tableLeft"><span style="color: red;margin-right: 4px;visibility: hidden">*</span>所属实验室</td>
                        <td>
                            <select id="lab" style="width: 400px;"></select>
                        </td>
                    </tr>
                    <tr>
                        <td class="tableLeft"><span style="color: red;margin-right: 4px;visibility: hidden">*</span>课程介绍</td>
                        <td><script id="introduce" name="introduce" type="text/plain"></script></td>
                    </tr>
                    <tr>
                        <td class="tableLeft"><span style="color: red;margin-right: 4px;visibility: hidden">*</span>课程大纲</td>
                        <td><script id="outline" name="outline" type="text/plain"></script></td>
                    </tr>
                    <tr>
                        <td  colspan="2" style="text-align: center">
                            <input id="submit" class="btn btn-primary size-MINI radius" type="button" value="确认">
                            <input id="refill" class="btn btn-default size-MINI" type="button" value="返回">
                        </td>
                    </tr>
                    </tbody>
                </table>
         
            </div>
        </div>
    </div><!-- 再次提交驳回课程 结束-->

</div>
<style> .del { cursor: pointer;} </style>
</body>
<script type="text/javascript" src="../../lib/jquery/3.1.1/jquery-3.1.1.min.js"></script>
<script type="text/javascript" src="../../lib/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../../lib/bootstrap-table/bootstrap-table.js"></script>
<script type="text/javascript" src="../../lib/bootstrap-table/locale/bootstrap-table-zh-CN.js"></script>
<script type="text/javascript" src="../../lib/ueditor/ueditor.config.js"></script>
<script type="text/javascript" src="../../lib/ueditor/ueditor.all.min.js"></script>
<script type="text/javascript" src="../../lib/ueditor/zh-cn.js"></script>
<script type="text/javascript" src="../../lib/layer/2.4/layer.js"></script>
<script>
    $("#addCurse").click(function () {
        var $ifrem = window.parent.document.getElementById("iframe");
        $($ifrem).attr("src","html/myCourse/startClass.html");
    });
    //加载我的课程已通过课程
    $.ajax({
        type:'get',
        url:'/api/applyTeacherCheckedList',
        dataType:'json',
        success:function (data) {
            if(data.code=="001"){
                var $table = $('#tableTop');
                var datas = data.result;
                $table.bootstrapTable('load',datas);
            } else {
                layer.msg(data.message,{icon:2});
            }
        },
        error:function(err){
            console.error(err);
        }
    });
    function operation (value, row, index) {
        return [
            '<a style="color: #338FD0" class="del" onclick="details(\''+ row.id + '\')">查看详情</a>',
            '<a style="margin-left:8px;color: red" class="del" onclick="del(\''+ row.id + '\')">删除</a>'
        ].join('');
    }
    function operation_1 (value, row, index) {
        return [
            '<a style="color: #338FD0" class="del" onclick="details(\''+ row.id + '\')" >查看详情</a>',
            '<a style="margin-left:8px;color: #338FD0" class="del" onclick="submit_again(\'' + index + '\')" >再次申请</a>',
            '<a style="margin-left:8px;color: red" class="del" onclick="del(\''+ row.id + '\')" >删除</a>'
        ].join('');
    }
    function details (id) {
        var $ifrem = window.parent.document.getElementById("iframe");
        $($ifrem).attr("src","html/myCourse/classDetails.html?id=" +id);
    }
    function del (id) {
        layer.open({
            title:false,
            icon: 3,
            content: '确认删除这条数据?',
            btn: ['确定', '取消'],
            yes: function(index){
                layer.close(index);
                $.ajax({
                    type:'post',
                    url:'/api/remove',
                    data: {id:id},
                    dataType:'json',
                    success:function (data) {
                        if(data.code=="001"){
                            $("tr[data-uniqueid='"+id+"']").remove();
                            layer.msg("删除成功",{icon:1});
                        }else{
                            layer.msg(data.message,{icon:2});
                        }
                    },
                    error:function(err){
                        console.error(err);
                    }
                });
            },btn2: function(){
            },cancel: function(){}
        });
    }//del() 结束
    
    //加载我的课程审核中的课程
    $.ajax({
        type:'get',
        url:'/api/applyTeacherWaitList',
        dataType:'json',
        success:function (data) {
            if(data.code=="001"){
                var $table = $('#tableDom');
                var datas = data.result;
                $table.bootstrapTable('load',datas);
            } else {
                layer.msg(data.message,{icon:2});
            }
        },
        error:function(err){
            console.error(err);
        }
    });//加载审核中的课程 结束

    var reject_lession_data = null; //存储被驳回的课程信息

    $.ajax({//加载被驳回的课程
        type:'get',
        url:'/api/reject_lessons',
        dataType:'json',
        success:function (data) {
            if(data.code=="001"){
                let $table = $('#reject_lesson');
                
                let datas = data.result;
                let num = datas.length;

                if ( num > 0 )
                {
                    reject_lession_data = datas;

                    for ( let i=0; i < num; i++ )
                    {
                        let t = datas[i].reason.split('||');
                        if ( t[1] )
                        {
                            datas[i].reason = t[0] + ', ' + t[1];
                        }else{
                            datas[i].reason = t[0];
                        }
                    }
                    
                }
                $table.bootstrapTable('load',datas);
                
            } else {
                layer.msg(data.message,{icon:2});
            }
        },
        error:function(err){
            console.error(err);
        }
    });//加载被驳回的课程 结束

    function thAlready(value, row, index) {
        if(row.status == '0') {
            return [
                '<span style="color: #2E6DA4"  title="">待审核</span>'
            ].join('');
        }else if(row.status == '1') {
            return [
                '<span style="color: green"  title="">审核通过</span>'
            ].join('');
        } else if(row.status == '2') {
            return [
                '<span style="color: red"  title="">审核未通过</span>'
            ].join('');
        }
    }

    //下面是 再次提交驳回课程 代码
    var apply_again = $('#apply_again');
    //加载select
    var select = document.getElementById('department');
    var option = "";
    select.innerHTML = null;

    //加载所属实验室select
    var labName = document.getElementById('lab');
    var labNameOption = "";
    labName.innerHTML = null;

    $.ajax({
        type: 'get',
        url: "/api/labList",
        dataType: 'json',
        success:function(data){
            data = data.result;
            labNameOption = "<option value='0' disabled='disabled' selected='selected'>--请选择实验室--</option>";
            for(var i = 0;i < data.length;i++){
                labNameOption +="<option value='"+data[i].id+"'>"+data[i].name + "</option>";
            }
            labName.innerHTML += labNameOption;
        }
    });

    $.ajax({
        type: 'get',
        url: "/api/listCollege",
        dataType: 'json',
        success:function(data){
            data = data.result;
            option = "<option value='0' disabled='disabled' selected='selected'>--请选择开课院系--</option>";
            for(var i = 0;i < data.length;i++){
                option +="<option value='"+data[i].id+"'>"+data[i].college_name + "</option>";
            }
            select.innerHTML += option;
        }
    });

    var curriculumName = $('#curriculumName');//课程名称
    var department = $(select);//院系
    var lab_name = $(labName);//所属实验室
    var sbmt = $('#submit'); //提交 按钮
    var refill = $('#refill'); //返回 按钮

    //设置富文本样式，初始化
    $("#introduce").css({"height":"200px","width":"100%"});
    $("#outline").css({"height":"200px","width":"100%"});
    var ues = UE.getEditor('introduce');
    var ue = UE.getEditor('outline');

    /*
    submit_again()：显示再次编辑提交
    */
    function submit_again (index)
    {
        curriculumName.val(reject_lession_data[index].curriculum_name);
        department.val(reject_lession_data[index].belong_college);
        lab_name.val(reject_lession_data[index].lab_id);
        ues.ready(
            function () { ues.setContent(reject_lession_data[index].curriculum_rec); },2
        );

        ue.ready(
            function () { ue.setContent(reject_lession_data[index].curriculum_guide); },2
        );

        sbmt.attr('lession', reject_lession_data[index].id);//被驳回课程的id
        apply_again.css('display', '');//显示再次提交的div
        let p = apply_again.offset().top;
        $(document).scrollTop(p-200);     
    }//submit_again 结束

    sbmt.click(function () {
        let lession_name = $.trim( curriculumName.val() );
        let depart = department.val();
        let lab_id = lab_name.val();
        let introduce = $.trim( ues.getContent() );
        let outline = $.trim( ue.getContent() );
        let lession_id = '';

        if ( (lession_id = $(this).attr('lession')) ) { }

        $.ajax({
            type:'post',
            url:'/api/apply',
            data: {
                'curriculum_name': lession_name,
                'curriculum_guide': outline,
                'curriculum_rec': introduce,
                'belong_college': depart,
                'lab_id':lab_id,
                'id': lession_id,
            },
            dataType:'json',
            success:function (data) {
                if(data.code=="001"){
                    layer.msg("开课申请已提交，耐心等待",{icon:6}, function(){
                        apply_again.css('display', 'none');//隐藏 再次提交的div
                        $(this).attr('lession', '');
                    });
                } else {
                    layer.msg(data.message,{icon:2});
                }
            },
            error:function(err){
                console.error(err);
            }
        })
    });//sbmt click 结束

    refill.click(function () {
        apply_again.css('display', 'none');//隐藏 再次提交的div
        sbmt.attr('lession', '');
    })
    //再次提交驳回课程 代码 结束
</script>

</html>